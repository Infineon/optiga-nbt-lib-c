<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>hsw-nbt: NBT APDU library</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">hsw-nbt<span id="projectnumber">&#160;1.1.1</span>
   </div>
   <div id="projectbrief">OPTIGA Authenticate NBT Host Library for C</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">NBT APDU library</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="nbt-apdu-library"></a> </p><blockquote class="doxtable">
<p>&zwj;C library to communicate with the OPTIGA&trade; Authenticate NBT </p>
</blockquote>
<p>The OPTIGA&trade; Authenticate NBT is a dynamic and secure turn-key solution for embedded NFC tag applications with varying levels of security and communication. The OPTIGA&trade; Authenticate NBT communicates with the smart phones and NFC readers via NFC and with the host MCU via I2C.</p>
<p>The OPTIGA&trade; Authenticate NBT APDU library allows the host application to send C-APDUs and receive R-APDUs from the OPTIGA&trade; Authenticate NBT controller. This library can be used with any communication channel, such as NFC and I2C. <br  />
</p>
<h1><a class="anchor" id="features"></a>
Features</h1>
<ul>
<li>Supports personalization and operational commands of the OPTIGA&trade; Authenticate NBT's Type-4-Tag applet</li>
<li>Configuration via the OPTIGA&trade; Authenticate NBT configurator applet</li>
<li>Extensible for any communication channel, such as NFC and I2C</li>
<li>Supports pass-through APDUs</li>
</ul>
<h1><a class="anchor" id="usage"></a>
Usage</h1>
<ol type="1">
<li><p class="startli">Include the following headers</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="ifx-error_8h.html">infineon/ifx-error.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="ifx-logger_8h.html">infineon/ifx-logger.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="ifx-protocol_8h.html">infineon/ifx-protocol.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="ifx-t1prime_8h.html">infineon/ifx-t1prime.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="ifx-utils_8h.html">infineon/ifx-utils.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="nbt-apdu_8h.html">infineon/nbt-apdu.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="nbt-cmd_8h.html">infineon/nbt-cmd.h</a>&quot;</span></div>
<div class="line"><span class="comment">// Add the headers of I2C protocol implementation libraries (Example: PSoC6)</span></div>
<div class="line"><span class="comment">// Add the headers of logger implementation libraries (Example: File logger)</span></div>
<div class="ttc" id="aifx-error_8h_html"><div class="ttname"><a href="ifx-error_8h.html">ifx-error.h</a></div><div class="ttdoc">Infineon specific error code creation and parsing.</div></div>
<div class="ttc" id="aifx-logger_8h_html"><div class="ttname"><a href="ifx-logger_8h.html">ifx-logger.h</a></div><div class="ttdoc">Generic logging API.</div></div>
<div class="ttc" id="aifx-protocol_8h_html"><div class="ttname"><a href="ifx-protocol_8h.html">ifx-protocol.h</a></div><div class="ttdoc">Generic protocol API (ISO/OSI stack).</div></div>
<div class="ttc" id="aifx-t1prime_8h_html"><div class="ttname"><a href="ifx-t1prime_8h.html">ifx-t1prime.h</a></div><div class="ttdoc">Global Platform T=1' protocol.</div></div>
<div class="ttc" id="aifx-utils_8h_html"><div class="ttname"><a href="ifx-utils_8h.html">ifx-utils.h</a></div><div class="ttdoc">Provides utility functions and macros.</div></div>
<div class="ttc" id="anbt-apdu_8h_html"><div class="ttname"><a href="nbt-apdu_8h.html">nbt-apdu.h</a></div><div class="ttdoc">NBT protocol API for exchanging APDUs with NBT product.</div></div>
<div class="ttc" id="anbt-cmd_8h_html"><div class="ttname"><a href="nbt-cmd_8h.html">nbt-cmd.h</a></div><div class="ttdoc">Collection of the NBT operational commands.</div></div>
</div><!-- fragment --></li>
<li><p class="startli">Initialize the command set</p>
<p class="startli">a. Initialize the logger handle</p>
<div class="fragment"><div class="line"><a class="code hl_typedef" href="ifx-error_8h.html#ac1e04ea3cb51d67fb865a51ed1d13634">ifx_status_t</a> status;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Logger handle to handle the printing of logs and error.</span></div>
<div class="line">ifx_logger_t logger_handle;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Initialize the logger using the platform-specific logger implementation APIs.</span></div>
<div class="line"><span class="comment">// Note: Without this initialization, the logger does not work. Refer`hsw-nbt/docs/userguide.md` for platform-specific implementations.</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Code placeholder </span></div>
<div class="line"> </div>
<div class="line">ifx_logger_set_level(&amp;logger_handle, <a class="code hl_enumvalue" href="ifx-logger_8h.html#a58eb6f51acc21bc8747887484fbd37e8a306e1132c93edb2afaa7fcda903ef89f">IFX_LOG_INFO</a>);</div>
<div class="ttc" id="aifx-error_8h_html_ac1e04ea3cb51d67fb865a51ed1d13634"><div class="ttname"><a href="ifx-error_8h.html#ac1e04ea3cb51d67fb865a51ed1d13634">ifx_status_t</a></div><div class="ttdeci">uint32_t ifx_status_t</div><div class="ttdoc">Custom return code type used by all Infineon host software libraries.</div><div class="ttdef"><b>Definition</b> <a href="ifx-error_8h_source.html#l00092">ifx-error.h:92</a></div></div>
<div class="ttc" id="aifx-logger_8h_html_a58eb6f51acc21bc8747887484fbd37e8a306e1132c93edb2afaa7fcda903ef89f"><div class="ttname"><a href="ifx-logger_8h.html#a58eb6f51acc21bc8747887484fbd37e8a306e1132c93edb2afaa7fcda903ef89f">IFX_LOG_INFO</a></div><div class="ttdeci">@ IFX_LOG_INFO</div><div class="ttdoc">Information that help trace the program's normal execution flow.</div><div class="ttdef"><b>Definition</b> <a href="ifx-logger_8h_source.html#l00068">ifx-logger.h:68</a></div></div>
</div><!-- fragment --><p class="startli">b. Initialize the protocol</p><ul>
<li>GP T=1' I2C protocol</li>
</ul>
<p class="startli">``&lsquo;c // Protocol to handle the GP T=1&rsquo; I2C protocol communication with tag ifx_protocol_t t1prime_protocol;</p>
<p class="startli">// Protocol to handle the MCU I2C drivers functionalities. ifx_protocol_t mcu_i2c_driver;</p>
<p class="startli">// Initialize the <code>ifx_protocol_t</code> object with the concrete implementation of the MCU I2C driver. // I2C protocol does not work without this initialization. Refer <code>hsw-nbt/docs/userguide.md</code> for platform-specific implementations. </p><pre class="fragment">// Code placeholder
</pre><p> // Use GP prime protocol channel as an interface to communicate with card. // Add I2C and Timer concrete implementation. <br  />
 status = ifx_t1prime_initialize(&amp;t1prime_protocol, &amp;mcu_i2c_driver);</p>
<p class="startli">status = ifx_protocol_activate(&amp;t1prime_protocol, NULL, NULL); ```</p>
<p class="startli">A sample API for implementation of MCU I2C driver initialization as per <code>ifx_protocol_t</code> struct is given below:</p>
<p class="startli"><code>c ifx_protocol_t mcu_i2c_driver; // Interface realization of PSoC6 I2C driver. status = ifx_i2c_psoc6_initialize(&amp;mcu_i2c_driver, &amp;logger_handle); </code></p>
<p class="startli">c. Initialize the OPTIGA&trade; Authenticate NBT command set with the required protocol handle and logger handle</p><ul>
<li>For GP T=1' I2C protocol</li>
</ul>
<p class="startli"><code>c // NBT command set object to handle all OPTIGA&amp;trade; Authenticate NBT operations. <a class="el" href="structnbt__cmd__t.html" title="Generic NBT command set structure for building and performing NBT commands.">nbt_cmd_t</a> command_set; // Initialize the OPTIGA&amp;trade; Authenticate NBT command set with GP T=1' protocol status = nbt_initialize(&amp;command_set, &amp;t1prime_protocol, &amp;logger_handle); </code></p>
</li>
<li><p class="startli">Communicate with the OPTIGA&trade; Authenticate NBT controller</p>
<p class="startli">An example to update and read the NDEF message is illustrated below:</p>
<div class="fragment"><div class="line"><span class="comment">// Select the OPTIGA&amp;trade; Authenticate NBT application.</span></div>
<div class="line">status = <a class="code hl_function" href="nbt-cmd_8h.html#a5d0030ad6b85e395ffcd756c5afef98c">nbt_select_application</a>(&amp;command_set);</div>
<div class="line"><span class="keywordflow">if</span> (<a class="code hl_function" href="ifx-error_8h.html#a79aadaf46afb0e520494aa22df32053e">ifx_error_check</a>(status) || !<a class="code hl_define" href="ifx-apdu_8h.html#ab7186a37edd97d1d92bcd9274b2db7b1">IFX_CHECK_SW_OK</a>(command_set.response-&gt;sw)) </div>
<div class="line">{    </div>
<div class="line">    <span class="comment">// Read the corresponding error message.</span></div>
<div class="line">    uint8_t *message = <a class="code hl_function" href="nbt-apdu_8h.html#a10cde10a6dd57336fa178e67773cd92a">nbt_error_message_get</a>(&amp;command_set);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Handle error</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Assign the FileID to read/update NDEF message.</span></div>
<div class="line">uint16_t file_id = 0xE104;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Record value to be updated in NDEF message</span></div>
<div class="line">uint8_t ndef_message[] = {0xD1, 0x01, 0x0D, 0x55, 0x02, 0x69,</div>
<div class="line">                          0x6E, 0x66, 0x69, 0x6E, 0x65, 0x6F,</div>
<div class="line">                          0x6E, 0x2E, 0x63, 0x6F, 0x6D};</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structifx__blob__t.html">ifx_blob_t</a> blob;</div>
<div class="line">blob.<a class="code hl_variable" href="structifx__blob__t.html#a7ea566f3b6aefa44aba61286ffab4c04">length</a> = <span class="keyword">sizeof</span>(ndef_message);</div>
<div class="line">blob.<a class="code hl_variable" href="structifx__blob__t.html#a2e51fe608c8f1c5b190915e64031615a">buffer</a> = ndef_message;</div>
<div class="line"><span class="comment">// Update NDEF message with URI record details.</span></div>
<div class="line">status = <a class="code hl_function" href="nbt-cmd_8h.html#a59aecf65b43c8336c8b70716c1dd58dd">nbt_ndef_update_with_id</a>(&amp;command_set, file_id, &amp;blob);</div>
<div class="line"><span class="comment">// Read the updated NDEF message.</span></div>
<div class="line">status = <a class="code hl_function" href="nbt-cmd_8h.html#ad6e55d259efaeb1747b02c9f54de4510">nbt_ndef_read_with_id</a>(&amp;command_set, file_id);</div>
<div class="line"><span class="comment">// command_set.response-&gt;data has the content.</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Select NDEF file by ID.</span></div>
<div class="line">status = <a class="code hl_function" href="nbt-cmd_8h.html#a73030283ed76be0324cc18d77be2d39a">nbt_select_file</a>(&amp;command_set, file_id);</div>
<div class="line"> </div>
<div class="line">uint8_t offset = 0x00;</div>
<div class="line">uint32_t length = <span class="keyword">sizeof</span>(ndef_message);</div>
<div class="line"><span class="comment">// Read binary data from the selected file, Offset 0, and Length 17 bytes.</span></div>
<div class="line">status = <a class="code hl_function" href="nbt-cmd_8h.html#a2f5c120e35b25dd689cfe56f840b7a9e">nbt_read_binary</a>(&amp;command_set, 0x00, blob.<a class="code hl_variable" href="structifx__blob__t.html#a7ea566f3b6aefa44aba61286ffab4c04">length</a>);</div>
<div class="line"><span class="comment">// command_set.response-&gt;data has the content</span></div>
<div class="ttc" id="aifx-apdu_8h_html_ab7186a37edd97d1d92bcd9274b2db7b1"><div class="ttname"><a href="ifx-apdu_8h.html#ab7186a37edd97d1d92bcd9274b2db7b1">IFX_CHECK_SW_OK</a></div><div class="ttdeci">#define IFX_CHECK_SW_OK(response_sw)</div><div class="ttdoc">Check APDU response status word(SW) is success(0x9000)</div><div class="ttdef"><b>Definition</b> <a href="ifx-apdu_8h_source.html#l00029">ifx-apdu.h:29</a></div></div>
<div class="ttc" id="aifx-error_8h_html_a79aadaf46afb0e520494aa22df32053e"><div class="ttname"><a href="ifx-error_8h.html#a79aadaf46afb0e520494aa22df32053e">ifx_error_check</a></div><div class="ttdeci">bool ifx_error_check(ifx_status_t status_code)</div><div class="ttdoc">Checks if status code indicates error.</div></div>
<div class="ttc" id="anbt-apdu_8h_html_a10cde10a6dd57336fa178e67773cd92a"><div class="ttname"><a href="nbt-apdu_8h.html#a10cde10a6dd57336fa178e67773cd92a">nbt_error_message_get</a></div><div class="ttdeci">uint8_t * nbt_error_message_get(const nbt_cmd_t *self)</div><div class="ttdoc">Returns the error message for last command executed by NBT command set.</div></div>
<div class="ttc" id="anbt-cmd_8h_html_a2f5c120e35b25dd689cfe56f840b7a9e"><div class="ttname"><a href="nbt-cmd_8h.html#a2f5c120e35b25dd689cfe56f840b7a9e">nbt_read_binary</a></div><div class="ttdeci">ifx_status_t nbt_read_binary(nbt_cmd_t *self, uint16_t offset, uint8_t binary_data_length)</div><div class="ttdoc">Reads the binary data from the currently selected elementary file.</div></div>
<div class="ttc" id="anbt-cmd_8h_html_a59aecf65b43c8336c8b70716c1dd58dd"><div class="ttname"><a href="nbt-cmd_8h.html#a59aecf65b43c8336c8b70716c1dd58dd">nbt_ndef_update_with_id</a></div><div class="ttdeci">ifx_status_t nbt_ndef_update_with_id(nbt_cmd_t *self, uint16_t file_id, ifx_blob_t *ndef_bytes)</div><div class="ttdoc">Updates the NDEF file with FileID. Method performs the select file with file_id and then update binar...</div></div>
<div class="ttc" id="anbt-cmd_8h_html_a5d0030ad6b85e395ffcd756c5afef98c"><div class="ttname"><a href="nbt-cmd_8h.html#a5d0030ad6b85e395ffcd756c5afef98c">nbt_select_application</a></div><div class="ttdeci">ifx_status_t nbt_select_application(nbt_cmd_t *self)</div><div class="ttdoc">Selects the NBT application.</div></div>
<div class="ttc" id="anbt-cmd_8h_html_a73030283ed76be0324cc18d77be2d39a"><div class="ttname"><a href="nbt-cmd_8h.html#a73030283ed76be0324cc18d77be2d39a">nbt_select_file</a></div><div class="ttdeci">ifx_status_t nbt_select_file(nbt_cmd_t *self, uint16_t file_id)</div><div class="ttdoc">Selects the elementary file (EF) with the FileID.</div></div>
<div class="ttc" id="anbt-cmd_8h_html_ad6e55d259efaeb1747b02c9f54de4510"><div class="ttname"><a href="nbt-cmd_8h.html#ad6e55d259efaeb1747b02c9f54de4510">nbt_ndef_read_with_id</a></div><div class="ttdeci">ifx_status_t nbt_ndef_read_with_id(nbt_cmd_t *self, uint16_t file_id)</div><div class="ttdoc">Reads NDEF file and return the NDEF message byte data. Method performs the select file and then read ...</div></div>
<div class="ttc" id="astructifx__blob__t_html"><div class="ttname"><a href="structifx__blob__t.html">ifx_blob_t</a></div><div class="ttdoc">Data storage for data and data length where both are required as parameters.</div><div class="ttdef"><b>Definition</b> <a href="ifx-utils_8h_source.html#l00189">ifx-utils.h:190</a></div></div>
<div class="ttc" id="astructifx__blob__t_html_a2e51fe608c8f1c5b190915e64031615a"><div class="ttname"><a href="structifx__blob__t.html#a2e51fe608c8f1c5b190915e64031615a">ifx_blob_t::buffer</a></div><div class="ttdeci">uint8_t * buffer</div><div class="ttdef"><b>Definition</b> <a href="ifx-utils_8h_source.html#l00195">ifx-utils.h:195</a></div></div>
<div class="ttc" id="astructifx__blob__t_html_a7ea566f3b6aefa44aba61286ffab4c04"><div class="ttname"><a href="structifx__blob__t.html#a7ea566f3b6aefa44aba61286ffab4c04">ifx_blob_t::length</a></div><div class="ttdeci">uint32_t length</div><div class="ttdef"><b>Definition</b> <a href="ifx-utils_8h_source.html#l00192">ifx-utils.h:192</a></div></div>
</div><!-- fragment --></li>
</ol>
<h1><a class="anchor" id="architecture"></a>
Architecture</h1>
<p>This image shows the software architecture of the library.</p>
<p><img src="./docs/images/hsw-apdu-nbt-architecture.png" alt="" width="500" class="inline"/></p>
<h1><a class="anchor" id="components"></a>
Components</h1>
<ul>
<li><b>Command set</b> This component acts as the API interface for the host application. This module is responsible for coordinating the building of APDU commands, sending the commands to the secure element through the communication interface, and receiving response from the secure element.</li>
<li><b>Command builder</b> This component helps in framing the command APDUs according to the OPTIGA&trade; Authenticate NBT applet specification.</li>
<li><b>Response parser</b> This component helps in decoding the response APDUs including response data and status word according to the OPTIGA&trade; Authenticate NBT applet specification.</li>
</ul>
<h1><a class="anchor" id="interaction"></a>
Interaction</h1>
<p>Below diagram describes the interaction between the components.</p>
<p><img src="./docs/images/hsw-apdu-nbt-interaction.png" alt="" width="500" class="inline"/></p>
<h1><a class="anchor" id="directory-structure-1"></a>
Directory structure</h1>
<p>The library directory is structured according to the Pitchfork Layout.</p>
<div class="fragment"><div class="line">hsw-apdu-nbt </div>
<div class="line">|-- .cmake/                 # Includes sources for dependency management</div>
<div class="line">|-- LICENSES/               # Includes list of licenses used for the library </div>
<div class="line">|-- data/                   # Includes Doxygen, cppcheck configuration files</div>
<div class="line">|-- docs/                   # Includes documentation, source files, images, and the generated API reference</div>
<div class="line">|-- include/                # Public Headers(.h) of the library</div>
<div class="line">|-- src/                    # Sources(.c) and Private headers(.h) of the library</div>
<div class="line">|-- .clang-format           # clang-format configuration file</div>
<div class="line">|-- .gitignore              # Library specific gitignore file </div>
<div class="line">|-- CMakeLists.txt          # CMake build configurations for the library</div>
<div class="line">`-- README.md               # Overview of the hsw-apdu-nbt library</div>
</div><!-- fragment --><h1><a class="anchor" id="dependencies-1"></a>
Dependencies</h1>
<ul>
<li><b>hsw-error</b> This dependent library is used for creating and parsing error information.</li>
<li><b>hsw-protocol</b> This dependent library provides the communication protocol interface for the OPTIGA&trade; Authenticate NBT APDU library. This protocol provides interfaces such as initialize, transceive, and terminate to communicate with an external application or product. This library can be implemented for any communication type, such as I2C, UART, and NFC.</li>
<li><b>hsw-utils</b> This dependent library provides the utility methods such as for byte conversions, string conversions, bit operations, and encoders/decoders for 2-byte TLV data.</li>
<li><b>hsw-logger</b> This dependent library is used for logging information/errors. This library can be implemented for loggers like file-logger and console-logger.</li>
<li><b>hsw-apdu</b> This dependent library helps in building the APDU command bytes and parses the APDU response bytes according to the ISO/IEC 7816-4 specification.</li>
<li><b>hsw-apdu-protocol</b> This dependent library is used for sending and receiving APDU command bytes according to the ISO/IEC 7816-4 specification.</li>
</ul>
<h1><a class="anchor" id="references-1"></a>
References</h1>
<ul>
<li>Infineon Technologies AG: <em>OPTIGA&trade; Authenticate NBT, Extended Datasheet</em> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
